# Лабораторная работа №4: Написание оптимизированного CI/CD файла

## Цель работы:
на примерах "плохого" и "хорошего" скриптов показать, как правильно организовать процесс непрерывной интеграции (CI) и непрерывного развертывания (CD), чтобы избежать ошибок и повысить качество программного обеспечения.


**CI/CD** — метод, позволяющий выпускать новые версии продукта, не управляя процессом вручную. Это помогает избежать человеческих ошибок, оптимизировать и ускорить процесс деплоя.

### Пример "плохого" CI/CD:

```
name: "Bad CI/CD Workflow"

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run script
        run: |
          echo "Starting script"
          bash script.sh

      - name: Clean up
        run: rm -rf temp/*
```

### Разберем ошибки:

- **Нет кэширования зависимостей**

Установка зависимостей `npm install` происходит на каждом запуске. Если повторять одни и те же действия несколько раз, процесс сборки сильно замедляется.


- **Деплой сразу на прод**

Деплой на стейдж не проводится, то есть нет должного тестирования. Есть огромный риск развернуть нерабочую версию с багами.


- **Только ветка master**

Запуск ограничивается только веткой master, и тестирование фич на других ветках не выполняется.


- **Прямой SCP для деплоя**

SCP потенциально не обеспечивает должной безопасности и, например, с ним не получится управлять откатами или версионированием.


- **Нет управления ошибками**

Статусы выполнения команд не проверяются, и чтобы узнать, где произошла ошибка, остается только гадать на кофейной гуще (или переписывать все полностью).




### Исправим вышеописанные ошибки и получим пример "хорошего" CI/CD:

```
name: "Good CI/CD Workflow"

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment variables
        run: echo "CONFIG_PATH=./config" >> $GITHUB_ENV

      - name: Run the script
        run: |
          echo "Running the script"
          bash script.sh
        continue-on-error: false

      - name: Clean up
        run: |
          echo "Cleaning up temporary files"
          rm -rf temp/*

      - name: Notify success
        if: success()
        run: echo "Deployment complete!"
        
      - name: Notify failure
        if: failure()
        run: echo "Something went wrong!"
```

**Что исправлено:**

1. Добавлено кэширование директории `node_modules` теперь при повторных запусках используются уже установленные пакеты. *В результате* процесс сборки стал быстрее.
2. Добавлен этап деплоя на стейдж для предварительного тестирования перед деплоем на прод. *В результате* появилась возможность потестить изменения перед основным релизом.
3. Включен запуск для merge requests, позволяющий тестировать код перед слиянием. *В результате* код можно проверять даже на более ранних этапах.
4. SCP заменен на более эффективный и гибкий для синхронизации rsync, позволяющий минимизировать передачу данных. *В результате* деплой не подвергается таким большим рискам, а еще стал быстрее.
5. Добавлен флаг `allow_failure`, который будет становиться true при ошибках, и деплой не происходил. *В результате* пайплайн остановится при возникновении ошибок на этапе тестирвоания.


## Вывод
После исправления ошибок "плохого" CI/CD деплой станет стабильнее, безопаснее и быстрее. В "хорошем" учтены все недочеты, и такой формат позволяет улучшить качество развертываемого кода и его надежность.
